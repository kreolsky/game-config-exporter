# From Google spreadsheets to JSON
Или как делать навороченные игровые конфиги силами одного гейм-дизайнера.

## Введение
Привет! Меня зовут Серёжа, я работаю гейм-дизайнером и люблю изобретать велосипеды, ради этого даже питон пришлось учить.
Так уж получается, что обычно я работаю в маленьких комнадах, даже когда в больших компаниях. И да, в маленьких командах почти невозможно отвлекать разработчиков на такую ерунду как админка для создания и хранения конфигов. Вот только игры надо как-то конфигурировать и желательно в человекочитаемом виде. Нужны конфиги! Приходится как-то выкручиваться :(

Ну, например, у меня в игре есть 10 мечей с разными параметрами, эта  параметры надо где-то хранить, а собираются эти мечи из кусков со своими параметрами, куски же выпадают из лутбоксов и их тоже надо как-то описать.

Видел случаи когда ГД, бедолага, руками, путаясь в скобках, собирал json, а потом мы правили баланс и выяснялось, что нужно поправить примерно пару тройку десятков файлов. К слову, именно у этого ГД я потом развил идею с конфигами в гуглодоках (Никита, привет!)

Я слишком ленив для такой работы, хочется больше времени заниматься ГД, а не правкой бесконечной кучи файлов.

### Так как же я делаю конфиги?
В гуглотабличках! Использую всю силу луны и гугля. Таблицы с игровыми данными, в тех же таблицах, заворачиваю в промежуточный, мною изобретённый формат (подозрительно похожий на json), потом забираю из гуглотаблицы питонячим скриптом (опять же, минутка рекламы, самописным!), который в свою очередь конвертит мой формат в полноценный json, хоть и с некоторыми ограничениями и сохраняет на рабочий комп. Полученные файлы уже можно заливать на сервер или включать в билд. Кстати, на сервер мой скрипт заливать тоже умеет :)

Про сам промежуточный формат и как он конвертится к json можно посмотреть в этой краткой [инструкции](https://docs.google.com/document/d/1O9mhLuzu7bnwDSfNqb7qo0N8-WZfDforyF-7WY7DRAI). Совсем кратко я расскажу ниже.
Зачем изобреать свой формат, да еще похожий на почти всем известный другой формат? Для простоты сбора строк средствами табличек, мой формат сильно проще, там нет разнообразия служебных символов и типов данных. Формат более человекочитаемый. Да, на конфиги таки часто приходится смотреть глазами и пытаться понять, почему эта фигня, которую ты городил последние пару часов, не работает.

Например, строка:
```python
'9.1, 6.0, 6 | zero = 0, one, two = {2, dva}, tree = 3 | a, b, f'
```
Будет экспортнута в json как:
```python
  [
    [ 9.1, 6, 6],
    [
      "one",
      {
         "zero": 0
         "two": [2, "dva"],
         "tree": 3
      }
    ],
    [ "a", "b", "f"]
  ]
```

Очевидно, что внутри гуглотаблички первую строку собрать сильно-сильно проще и она более человекочитаемая.
Средний блок с сюрпризом, да, но это расплата за простоту формата. Если внутри блока есть части словаря, то они будут собраны в один словарь. В реальных конфигах я на это ограничение ни разу не попадал.

Есть и еще ограничения, из самых очевидных, словарь (в терминах питона) у меня всегда заворачивается в список, сделано это, опять же, ради простоты формирования. Чаще всего словари идут пачками. Например, цена это список словарей с указанием какая валюты и сколько её нужно. Если я хочу продавать меч тысячи истин не только за золотые, а за золотые, жабьи лапки и два хвоста крыс, то мне нужен список словарей. Что бы не помечать отдельно когда список нужен, а когда нет, то проще всегда заворачивать словари в список, а программистов поставить перед фактом (аргментируя тем, что раз они не захотели писать админку, то пусть и не возмущаются). У меня прокатило :)

Сам конвертов в json, с примерами, можно найти [тут](https://github.com/kreolsky/game-config-exporter/blob/master/bot/gss_exporter_bot/tools.py)

А вот так выглядит [реальный конфиг](https://docs.google.com/spreadsheets/d/1cbNBO69iUcX7CIx6E55Hy1XDdQ9IJp9mWF3u6g8CDpY) (подразумеваю, что читатель уже заглянул в [инструкцию](https://docs.google.com/document/d/1O9mhLuzu7bnwDSfNqb7qo0N8-WZfDforyF-7WY7DRAI)). Это лутбоксы, самая простая реализация. Если будут желающие, могу рассказать идею подробней.

### В чем выгода?
Простота и быстрый старт! Можно сразу начать работу без дополнительных телодвижений и получать приемлимый результат. Это в меру удобно, под рукой вся мощь луны и гугля, в одной таблице можно хранить и расчеты, калькулятор и файло для экспорта. Поменял, тут же экспортнул в json и сразу получил актуальные конфиги.

Все это можно поддерживать силами одного гейм-дизайнера, который имеет хоть малейшее предствление как работать с табличными редакторами и обучаем на столько, что может запускать питонячий скрипт.

В моём случае с таблицами активно работают ПМ и тестировщик, не отвлекая меня когда нужно внести изменение для тестов или для добавления нового контента.

### В чем недостаки?
Выше я немного слукавил, все не так радужно, приходится заморачиваться с кастомными формулыми гуглотаблиц, привыкнуть к промежуточному формату,  который порождает избыточность данных в таблицах, что легко заметить в примерах, при условии, что это не самые сложные и обьёмные конфиги.

Нет версионности, сложно контролировать целостность документы, иногда отваливаются гуглоформулы. Сложно иметь разные конфиги если нужно поддерживать сразу несколько серверов и особенно с разыми версиями конфигов.

Но даже со всеми этими недостатками это сильно проще чем писать свою админку для редактирования и экспорта конфигов. И, повторюсь, самое важное, это можно сделать вот прям сейчас и сразу, силами одного ГД!

## Как готовить конфиги?
Конфига надо готовить. Совсем простые, формата ключ = значение легко, достаточно двух колонок в одной ключи, в другой, как не сложно догадаться, значения :) Навороченные уже сложней, нужна структура и понимание как этот конфиг будет выглядеть в конечном json и как оно будет заворачиваться с промежуточный формат.

Пожалуй, проще всего разобрать на примерах.

### Совсем простой случай
Начнем с совсем простого случая, нужен словарь (json объект) с параметрами, например какие-то игровые константы, пускай скорость это будет время восполнения единицы жизни \ маны и максимальные лимиты жизни и маны. Тогда создаем примерно такую табличку — [@general1.json](https://docs.google.com/spreadsheets/d/1hEF2zwU71Gpdtn6UVcuqNFA6N7rlV1GsvaAw27hOAac/edit#gid=0).

* Первая строка зарезервирована под заголовки либо служебные метки. В нашем случае это системные метки "key" и "value", по ним конвертор понимает что из этого нужно сделать словарик и будут экспортирвоаны только эти два столбца.
* В остальных может быть что угодно, комментарии, расчеты. Столбцы с данными даже могут не находится рядом. В строках ниже идут данные, в key название переменных, в value — значения. На выходе будет валидный [json документ](https://github.com/kreolsky/game-config-exporter/blob/master/bot/json/general1.json)

Можно заполнять таблицу по другому — [@general2.json](https://docs.google.com/spreadsheets/d/1hEF2zwU71Gpdtn6UVcuqNFA6N7rlV1GsvaAw27hOAac/edit#gid=174689602). В певой строке ключи, в строках ниже значения. В общем случае, строк со значениями может быть много. Важный момент, ключи должны быть именно в первой строке! Если хочется промежуточных данных то всегда можно завести дополнительные страницы, там делать все расчеты а результат складывать во вкладку для экспорта.

Вот так мы плавно подошли к чуть более сложному способу хранения данных.

### Более сложный случай
Обычно, в игре много сущностей одного типа и хочется их как-то аккуратно хранить и меть возможность редактировать. Попробуем на игрушечном примере [с мечами](https://docs.google.com/spreadsheets/d/1hEF2zwU71Gpdtn6UVcuqNFA6N7rlV1GsvaAw27hOAac/edit#gid=1939078248) — это уже страница для экспорта. Для каждого предмета у нас есть набор параметров. Первая строка, как всегда, заголовки, остальные строки значений, по одной строке на предмет. Вот только это уже довольно сложный конфиг, хочется большей свободы, поэтому вкладка экспорта при помощи двух формал собирается из данных в "калькуляторе" на соседней вкладке. Это удобно, можно допускать вольности в форматировании.

Основа та же, есть строка с заголовками и есть строки с данными, но все свободней, каждый предмет конфигурируется в несколько строк и имеет не совсем очевидные параметры. Пойдем по порядку.

Есть набор простых параметров, на них акцентироваться не будем, они заполняются руками, либо как результат формул, а есть более интересные параметры, состоящие из сложной структуры. Например, для каждого меча мы хотим сделать спец. способность, а то и несколько на один! Это возможно :)

Каждая спец. способность состоит из имени абилки и силы её действие, таких абилок у предмета может быть несколько. На каждую абилку свою строку. Тут важно разделять предметы пустыми строками и следить чтоб абилки одного предмета не выползли в зону другого. Сами же абилки задаются вполне интуитивно, в первом столбце имя абилки, во втором сила. А вот собираются в одну строку уже немного сложней (помним, у нас должна быть одна строка на один предмет). Для этого у меня подготовлены кастомные функции в гуглотаблицах, самая востребованная — __toConfigBlock__. Описание и примеры как она работает можно найти на странице калькулятора если ткнуть в формулу под заголовком __extra_power__.

Аналогично абилкам задается и цена. Проще потыкать в пример и понять, там нет ничего сложного :)
Вот тут и обоснование почему словари у меня всегда завернуты в список, где-то цена состоит из одной валюты, а где-то из трех, нужна универсальная схема и практика показала, что проще всегда заворачивать словарь в список чем усложнять формат.

Названия абилок и ресурсов в цене должны храниться в другом конфиге или уже захардкожены в игре.

### Общие рекомендации по работе с конфигами
У меня есть набор рекомендаций которым я следую при работе с конфигами. Пройдусь по ним кратким списком:
* Вкладки на экспорт я отмечаю красным, рабочие документы — зеленым, справочники которые подгружаются из других документов голубым;
* Ячейки которые вбиваются руками — зеленые, собирающиеся при помощи формул светло-красные, ячейки в которых находится формула — красные;
* Обязательно оставлять себе будущему комментарии, это супер важно! Тот будущий чувак обладает очень плохой паматью, пожалейте его;
* Данные, которые будут использованы более чем в одном документе лучше хранить в отдельной таблице и подгружать в рабочие документы как справочник, так можно избежать множественых редактирований по всем документам если у вас изменились базовые константы на которых строится баланс;
* Излишне громоздние, но быстрые нативные формулы я стараюсь заменить на лаконичные кастомные. Делаю выбор в пользу простоты чтения и заботе о том будущем чуваке который их будет читать. Но без фанатизма, таки кастомные формулы работаю заметно (заметно!) медленей чем нативные.

## Начало работы
Итак, как начать работать с этим чудо-костылём? Попробуем пройтись по пунктам.

### Скопировать или содать конфиг в нужном формате
Для начала стоит скопировать себе папку с примерами и таблицей конфигурации для скрипта которые забирает конфиги из гуглодоки.
* [Папка в гуглодрайве с конфигами](https://drive.google.com/drive/folders/1nyT-1DiYZzszFaiGvp7bJr6Q9UA63Egf)
* [Краткая инструкция по работе с конфигами](https://docs.google.com/document/d/1O9mhLuzu7bnwDSfNqb7qo0N8-WZfDforyF-7WY7DRAI)
* [Документ с настройками и всеми необходимыми для работы функциями](https://docs.google.com/spreadsheets/d/1qAaCU0ERtuzPY6LNHU2FQSkkaBS_-gLmvjwzvW-lcaA)

Можно и не копировать, а создать свой, но советую таки скопировать, там уже подготовлена база, в том числе и из кастомных функций, которые знатно облегчают жизнь при работе со сложными конфигами. Каждая функция документирована. Не ленитесь залезть в редактор сриптов _(Tools \ Script Editor)_ и посмотреть что там есть. Из одного документа в другой функции можно копировать либо подключать как библиотеку.

Внимательно посмотрите на файл с [настройками для конфигов](https://docs.google.com/spreadsheets/d/1qAaCU0ERtuzPY6LNHU2FQSkkaBS_-gLmvjwzvW-lcaA), начать со вкладки read.me! и пройтись по остальным вкладкам, читаю комментарии. Я старался подробно всё описать.

**ВАЖНО!** Названия страниц которые экспортируются должны начинаться с символа собаки "@", иначе они не будут забираться скриптом экспорта.

Итак, конфиг готов. Пойдем дальше.

### Настроить доступ скрипту к папке с конфигами
Я делал по [этой инструкции](https://www.youtube.com/watch?v=Bf8KHZtcxnA). Там всё просто.

Дальше есть варианты, в зависимости от сложности конфига, если у вас очень простой конфиг на одну тсраницу, для которого не нужно городить все эти сложноси с таблицей настроек. Тогда можно воспользоваться простым вариантом.

### Простой вариант:
Если конфиг простой и весь умещается в одной таблице, то можно не заморачиваться и хранить все в одной гуглтабличке с разбивкой по страницам. Данные из таблицы будут загружаться локально, в туже папку где находится скрипт.

Да, подразумеваю, что читатель либо немного знает питон либо под рукой есть тот кто его знает. Тут всё реально просто. Правда-правда!

1. Склонируйте или скачайте файло из [репозитория](https://github.com/kreolsky/game-config-exporter)
2. Установите все зависимости для работы срипта из файла __config/requirements.txt__
3. Отредактируйте __bot/local_lite.py__ дописав туда ID таблицы с конфигом и путь до файла с токеном авторизации к гуглодрайву.
4. Запускайте скрипт, он должен достучаться до гуглтаблиц и сохранить все вкладки которые начинаются с "@".

ID таблицы можно найти в урле до этой самой таблици, многосимвольный фрагмент, что-то типа _1cbNBO69iUcX7CIx6E55Hy1XDdQ9IJp9mWF3u6g8CDpY_

# UNDER CONSTRUCTION!!!!!

### Сложный вариант
Для сложных конфигов, которые не умещаются в один документ.
Страница со списком всех конфигов и прочими настройками для работы.

#### Переименовать  settings-example.py в settings.py и заполнить.
ID таблицы с настройками \ простым конфигом добавить в settings.py (сам ид таблицы брать из урла)

#### Для локальной работы:
Установите все зависимости из файла __config/requirements.txt__ и запускайте скрипт из __bot/local.py__
Конфиги будут браться из гуглотаблиц и сохраняться в локальной папке.

Если хочется автоматом сохранять конфиги на сервер, будет оно работать только под линуксами и на макоси.
Нужен доступ на целевой сервер по ssh ключу. Конфиги будут загружаться с гуглодок, сохраняться локально и заливаться на сервер.

#### В виде сервиса:
Для выкладывания на сервер в виде докер контейнера и управление экспортёром через телеграм:
  - Выложить бота на сервер с докером, можно туда же куда нужно складывать конфиги
  - Cоздать пару ключей (id_rsa, id_rsa.pub) и положить их в config/
    Приватный ключ будет скопирован в недра docker контейнера, публичный же нужно добавить на сервера куда будет ломиться скрипт
  - Содать бота у BotFather телеграма. Узнать токен и инициировать вебхуки
    telebot_init_string = f'https://api.telegram.org/bot{telebot_token}/setWebhook?url=https://monitor.rfp.poker/useless/{telebot_token}'
    telebot_del_string = f'https://api.telegram.org/bot{telebot_token}/deleteWebhook'
