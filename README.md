# game-config-exporter
Export game config from google spreadsheet to json

## Что это?

## Подготовка конфигов

### Представиться
Меня зовут Серёжа, я ГД и я люблю изобретать велоипеды, ради этого даже питон пришлось учить.
Так уж получается, что обычно я работаю в маленьких комнада, даже когда в больших компаниях. А игры надо как-то конфигурировать и желательно в человеко читаемом виде.
И да, в маленьких командах жалко отвлекать разработчиков на такую ерунду как админка для создания и хранения конфигов. А конфиги-то нужны! Вот и приходится самому выкручиваться :(

### Так как же я храню конфиги?
В гуглотабличках! Использю всю силу луны и гуглотаблиц. Потом это добро экспортирую в промежуточный, мною изобретенный формат (подозрительно похожий на JSON), потом забираю питонячим скриптом (опять же, самописным!), который в свою очередь конвертит мой промежуточный фортам в полноценный JSON хоть и с некоторыми ограничениями. Дальше это добро можно заливать на сервер или включать в билд. Кстати, на сервер мой скрипт заливать тоже умеет :)

Про сам промежуточный формат и как он конвертится к JSON можно посмотреть в этой краткой [инструкции](https://docs.google.com/document/d/1O9mhLuzu7bnwDSfNqb7qo0N8-WZfDforyF-7WY7DRAI). Совсем кратко я расскажу ниже.

Зачем изобреать свой формат, да еще похожий на всем известный другой формат? Для простоты бора строк для экспорта, этот формат сильно проще, там нет разнообразия служебных символов и типов данных. Формат более человекочитаемый. Да, на окнфиги таки часто приходится смотреть глазами и пытаться понять почему эта фигня, которую ты городил последние пару часов, не работает.

Например, строка:
  '9.1, 6.0, 6 | zero = 0, one, two = {2, dva}, tree = 3 | a, b, f'

Будет экспортнута в джейсон как:
  [
    [ 9.1, 6, 6],
    [
      "one",
      {
         "zero": 0
         "two": [2, "dva"],
         "tree": 3
      }
    ],
    [ "a", "b", "f"]
  ]

Очевидно, что внутри гуглотаблички первую строку собрать сильно проще. Она более человекочитаемая. Средний блок с сюрпризом, да, но это расплата за простоту формата.
Есть и еще ограничения, из самых очевидных, словарь ()в терминах питона) у менея всегда заворачивается в список, сделано это опять же ради простоты формирования. Чаще всего словари идут пачками, например цена это список словарей с указанием какая валюты и сколько её нужно. Если я хочу продавать меч тысячи истин не только за золотые, а за золотые, жабью лапку и хвост крысы, то мне нужен список словарей. Что бы не помечать отдельно когда список нужен, а когда нет, проще всегда заворачивать, а программистов поставить перед фактом (аргментируя тем, что раз они не захотели писать админку, то пусть и не возмущаются).

### В чем выгода?
Простота, все это можно поддерживать силами одного гемдизйнера.
В меру удобно, можно использовать всю силу гуглодокументов.

### В чем недостаки?
Приходится заморачиваться с кастомными формулыми и отдельным форматом хранения конфигов, что накладывает некоторые неудобства на работу.
Нет версионности, сложно контролировать целостность документы, иногда отваливаются гуглоформулы. Ваши варианты?

### Как готовить конфиги?
[Документ с настройками и всеми необходимыми для работы функциями](https://docs.google.com/spreadsheets/d/1qAaCU0ERtuzPY6LNHU2FQSkkaBS_-gLmvjwzvW-lcaA)
[Пример конфига](https://docs.google.com/spreadsheets/d/1cbNBO69iUcX7CIx6E55Hy1XDdQ9IJp9mWF3u6g8CDpY)
[Краткая инструкция по работе с конфигами](https://docs.google.com/document/d/1O9mhLuzu7bnwDSfNqb7qo0N8-WZfDforyF-7WY7DRAI)

## Экспорт конфигов. Как работает

## Как настроить?

### Общие настройки
#### Скопировать себе гуглотаблицу где в дальнейшем будут храниться конфиги
Создать конфиг \ пачку конфигов :)

#### Настроить доступ к гуглодокам
Примерно так https://www.youtube.com/watch?v=Bf8KHZtcxnA

### Простой вариант:
Если конфиг простой и весь умещается в одной таблице, то можно не заморачиваться и хранить все в оной гуглтабличке с разбивкой по страницам.
Данные из таблицы будут загружаться локально. Если сильно хочется можно допилить до необходимого функционала :)


Установите все зависимости для работы срипта из файла config/requirements.txt

Все необходимые для работы данные сохраняются непосредственно bot/local_lite.py
Отредактировать скрипт, дописав туда ид тублицы в config_table_id и относительный путь до гуглового токена авторизации.

### Сложный вариант
Для сложных конфигов, которые не умещаются в один документ.
Страница со списком всех конфигов и прочими настройками для работы.

#### Переименовать  settings-example.py в settings.py и заполнить.
ID таблицы с настройками \ простым конфигом добавить в settings.py (сам ид таблицы брать из урла)

#### Для локальной работы:
Установите все зависимости из файла config/requirements.txt и запускайте скрипт из bot/local.py
Конфиги будут браться из гуглотаблиц и сохраняться в локальной папке.

Если хочется автоматом сохранять конфиги на сервер, будет оно работать только под линуксами и на макоси.
Нужен доступ на целевой сервео по ssh ключу. Конфиги будут загружаться с гуглодок, сохраняться локально и заливаться на сервер.

#### В виде сервиса:
Для выкладывания на сервер в виде докер контейнера и управление экспортёром через телеграм:
  - Выложить бота на сервер с докером, можно туда же куда нужно складывать конфиги
  - Cоздать пару ключей (id_rsa, id_rsa.pub) и положить их в config/
    Приватный ключ будет скопирован в недра docker контейнера, публичный же нужно добавить на сервера куда будет ломиться скрипт
  - Содать бота у BotFather телеграма. Узнать токен и инициировать вебхуки
    telebot_init_string = f'https://api.telegram.org/bot{telebot_token}/setWebhook?url=https://monitor.rfp.poker/useless/{telebot_token}'
    telebot_del_string = f'https://api.telegram.org/bot{telebot_token}/deleteWebhook'
